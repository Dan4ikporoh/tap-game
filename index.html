<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Doodle Jumper</title>
    <style>
        /* --- Общие стили --- */
        body { margin: 0; padding: 0; background: #1c1c1e; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        canvas { background: #d0f4f7; border-radius: 10px; }
        .hud { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; color: #333; font-size: 24px; font-weight: bold; }
        .hud-button { padding: 8px 15px; background: rgba(255,255,255,0.7); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* --- Стили модального окна вывода --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #2c2c2e; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; position: relative; color: white; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; cursor: pointer; }
        h2 { text-align: center; margin-top: 0; }
        input { width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #555; border-radius: 8px; box-sizing: border-box; background: #3a3a3c; color: white; font-size: 16px; }
        .conversion-text { font-size: 14px; color: #aaa; text-align: left; margin: -5px 0 15px 0; }
        form button { width: 100%; background-color: #4CAF50; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* --- Анимация успеха --- */
        .success-animation { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 200; }
        .checkmark { width: 100px; height: 100px; border-radius: 50%; display: block; stroke-width: 4; stroke: #4CAF50; stroke-miterlimit: 10; margin: 10% auto; box-shadow: inset 0px 0px 0px #4CAF50; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: #7ac142; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 60px #fff; } }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="375" height="667"></canvas>
    <div class="hud">
        <button id="admin-btn" class="hud-button">Админ</button>
        <div id="score">0</div>
        <button id="withdraw-btn" class="hud-button">Вывести</button>
    </div>

    <!-- Модальное окно вывода -->
    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-btn">&times;</span>
            <h2>Вывод бонусов</h2>
            <form id="withdraw-form">
                <label for="coins-input">Сколько бонусов вывести?</label>
                <input type="number" id="coins-input" placeholder="Например, 100">
                <p class="conversion-text">Вы получите: <span id="money-display">0</span> RUB</p>
                <label for="nickname-input">Ваш никнейм</label>
                <input type="text" id="nickname-input" placeholder="@ваш_ник">
                <button type="submit">Отправить</button>
            </form>
        </div>
    </div>
    
    <!-- Анимация успеха -->
    <div id="success-animation" class="success-animation">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        
        // --- Настройки игры ---
        let score = 0;
        let highscore = 0;
        const player = { x: canvas.width / 2 - 15, y: canvas.height - 60, width: 30, height: 30, dy: 0, jumpPower: -8, gravity: 0.2 };
        const platforms = [];
        const platformCount = 10;
        let cameraY = 0;
        let gamePaused = false;

        function createPlatforms() {
            for (let i = 0; i < platformCount; i++) {
                platforms.push({ x: Math.random() * (canvas.width - 60), y: canvas.height - 70 * i, width: 60, height: 10 });
            }
        }

        function loop() {
            if (gamePaused) return;
            requestAnimationFrame(loop);

            // Логика
            player.dy += player.gravity;
            player.y += player.dy;

            if (player.y > cameraY + canvas.height) { // Упал вниз
                resetGame();
            }

            // Камера следует за игроком
            if (player.y < cameraY + canvas.height / 2) {
                cameraY = player.y - canvas.height / 2;
            }

            platforms.forEach(p => {
                if (player.dy > 0 && player.x < p.x + p.width && player.x + player.width > p.x && player.y + player.height > p.y && player.y + player.height < p.y + p.height) {
                    player.dy = player.jumpPower;
                    score++; // +1 очко за прыжок
                    scoreEl.textContent = score;
                }
            });

            // Генерация новых платформ наверху
            while (platforms[0].y > cameraY + 70) {
                platforms.shift();
                platforms.push({
                    x: Math.random() * (canvas.width - 60),
                    y: platforms[platforms.length - 1].y - 70,
                    width: 60,
                    height: 10,
                });
            }

            // Отрисовка
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(0, -cameraY);

            // Игрок
            ctx.fillStyle = 'green';
            ctx.fillRect(player.x, player.y, player.width, player.height);

            // Платформы
            ctx.fillStyle = 'brown';
            platforms.forEach(p => {
                ctx.fillRect(p.x, p.y, p.width, p.height);
            });
            
            ctx.restore();
        }

        function resetGame() {
            if (score > highscore) highscore = score;
            score = 0;
            scoreEl.textContent = score;
            player.x = canvas.width / 2 - 15;
            player.y = canvas.height - 60;
            player.dy = 0;
            cameraY = 0;
            platforms.length = 0;
            createPlatforms();
        }

        // Управление
        canvas.addEventListener('touchmove', (e) => {
            player.x = e.touches[0].clientX - canvas.getBoundingClientRect().left - player.width / 2;
        });
        canvas.addEventListener('mousemove', (e) => {
            player.x = e.clientX - canvas.getBoundingClientRect().left - player.width / 2;
        });

        // --- Логика интерфейса ---
        const adminBtn = document.getElementById('admin-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const modal = document.getElementById('withdraw-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const withdrawForm = document.getElementById('withdraw-form');

        adminBtn.addEventListener('click', () => {
            tg.openTelegramLink('https://t.me/Dead_Hard11'); // !!! ЗАМЕНИТЕ НА ВАШ НИКНЕЙМ !!!
        });
        withdrawBtn.addEventListener('click', () => {
            gamePaused = true;
            document.getElementById('coins-input').value = highscore;
            document.getElementById('money-display').textContent = highscore; // 1 бонус = 1 рубль
            modal.style.display = 'flex';
        });
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            gamePaused = false;
            loop();
        });
        withdrawForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const coins = document.getElementById('coins-input').value;
            const nickname = document.getElementById('nickname-input').value;
            if (!coins || !nickname || coins <= 0) {
                tg.showAlert('Пожалуйста, заполните все поля корректно.');
                return;
            }
            tg.sendData(JSON.stringify({ type: 'withdraw', coins: coins, nickname: nickname }));
            
            // Показываем анимацию и закрываем все
            modal.style.display = 'none';
            const successAnimation = document.getElementById('success-animation');
            successAnimation.style.display = 'flex';
            setTimeout(() => tg.close(), 1500); // Закрываем игру через 1.5с
        });

        createPlatforms();
        loop();
    </script>
</body>
</html>

